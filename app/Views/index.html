{% extends "layouts/base.html" %}

{% block content %}
<div class="jumbotron">
    <lottie-player src="https://assets5.lottiefiles.com/packages/lf20_rycdh53q.json"
                background="transparent"
                speed="1"
                style="width: 500px; height: 300px;" loop autoplay>
    </lottie-player>
    <hr class="my-4">
    <h2>ë‚œìˆ˜ì¿ í° ìƒì„±í•˜ê¸°</h2>
    <p>ë°ì´í„°ë² ì´ìŠ¤ì— ë‚œìˆ˜ ë²ˆí˜¸ë¡œ ëœ ì¿ í°ì„ ìƒì„±í•©ë‹ˆë‹¤. <br>
    í˜„ì¬ëŠ” ëŒ€ì„±ë§ˆì´ë§¥, ì¡±ë³´ë‹·ì»´ë§Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ğŸ˜‡</p>
    <form id="myForm">
        <div class="mb-3">
            <label for="formFile" class="form-label">Type</label>
            <select name="type" class="form-select" aria-label="íƒ€ì…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”">
                <option value="daesung" selected>ëŒ€ì„±ë§ˆì´ë§¥</option>
                <option value="zocbo">ì¡±ë³´ë‹·ì»´</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="formFile" class="form-label">File</label>
            <input class="form-control" type="file" id="my-file" name="my-file" accept=".xlsx">
            <div id="fileHelp" class="form-text">í—ˆìš© í™•ì¥ì: .xlsx</div>
        </div>
        <button type="submit" class="btn btn-secondary">ë¯¸ë¦¬ë³´ê¸°</button>
        <button type="reset" class="btn btn-outline-secondary" id="reset">ì´ˆê¸°í™”</button>
    </form>
    <div id="preview" class="mt-3"></div>
</div>
<script>
    reset.onclick = () => {
        preview.innerHTML = '';
    };

    myForm.onsubmit = async (e) => {
        e.preventDefault();

        try {
            let response = await fetch('/api/preview', {
                method: 'POST',
                body: new FormData(myForm)
            });
            let result = await response.json();

            // ì—ëŸ¬ ì²˜ë¦¬
            if (result.code !== 200)
                throw new Error('[Error:' + result.code + '] ' + result.message);

            // í”„ë¦¬ë·° ì¶œë ¥
            preview.innerHTML = result.render;
            // ìƒì„±í•˜ê¸°
            make.onclick = () => { createCoupon(result) };
        } catch (e) {
            alert(e.message);
        }
    }

    async function createCoupon(data) {
        let formData = new FormData();
        formData.append('data', JSON.stringify(data.data));
        formData.append('maxId', data.maxId);

        try {
            let response = await fetch('/api/coupon', {
                method: 'POST',
                body: formData,
            });
            let result = await response.json();

            // ì—ëŸ¬ ì²˜ë¦¬
            if (result.code !== 200)
                throw new Error('[Error:' + result.code + '] ' + result.message);

            // ì™„ë£Œ ì–¼ëŸ¿ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            alert(result.message);
            location.reload();
        } catch (e) {
            alert(e.message);
        }
    }
</script>
{% endblock %}